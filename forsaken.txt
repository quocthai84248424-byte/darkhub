--[[
    DARK HUB - FINAL VIP V9 (ULTIMATE STABLE)
    AUTHORIZED: hieuzed05 & HannahPrimalMystic
    FIXED: Nil Value, Smart Gen Detection, Global Fake Name, Server Hop Logic
]]--

--// SECURITY & WHITELIST
local _0xAUTH = {
    ["hieuzed05"] = true,
    ["HannahPrimalMystic"] = true
}

local _0xP = game:GetService("Players").LocalPlayer
if not _0xAUTH[_0xP.Name] then _0xP:Kick("Access Denied") return end

--// CONFIG FLAGS
getgenv().AutoFarm = false
getgenv().AutoHop = false
getgenv().SolveDelay = 1.2 -- Theo yêu cầu 1.2 giây

--// UI INITIALIZATION (Sử dụng Rayfield như trong ảnh)
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
   Name = "DARK HUB V9 | PRIVATE",
   Theme = "Darker",
   ConfigurationSaving = { Enabled = true, FolderName = "DarkHubV9", FileName = "Config" }
})

--// TAB: AUTOMATION
local MainTab = Window:CreateTab("Automation", 4483362458)

MainTab:CreateToggle({
   Name = "Auto Farm Gen & Smart Hop",
   CurrentValue = false,
   Flag = "FarmToggle",
   Callback = function(v) 
      getgenv().AutoFarm = v 
      getgenv().AutoHop = v -- Gộp Hop SV và Auto Farm
   end,
})

MainTab:CreateSlider({
   Name = "Solve Delay (Seconds)",
   Range = {0.1, 5},
   Increment = 0.1,
   Suffix = "s",
   CurrentValue = 1.2,
   Flag = "SpeedSlider",
   Callback = function(v) getgenv().SolveDelay = v end,
})

--// TAB: SETTINGS
local SettTab = Window:CreateTab("Settings", 4483362458)

SettTab:CreateButton({
   Name = "Fake Name (Bacon1607) - Global @",
   Callback = function()
      local fName = "bacon1607"
      pcall(function()
          _0xP.DisplayName = fName
          _0xP.Name = fName -- Thử ép cả username nội bộ để hiện @
          if _0xP.Character and _0xP.Character:FindFirstChild("Humanoid") then
              _0xP.Character.Humanoid.DisplayName = fName
          end
      end)
      Rayfield:Notify({Title = "Identity", Text = "Fake Name & @ Activated", Duration = 3})
   end,
})

--// SMART SERVER HOP LOGIC
local function SmartHop()
    local Http = game:GetService("HttpService")
    local TP = game:GetService("TeleportService")
    local Servers = Http:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    for _, s in pairs(Servers.data) do
        if s.playing < s.maxPlayers and s.id ~= game.JobId then
            TP:TeleportToPlaceInstance(game.PlaceId, s.id)
            break
        end
    end
end

--// AUTO SOLVER (Dựa trên ảnh Connect the Dots)
local function SolveGenPuzzle()
    local PlayerGui = _0xP:WaitForChild("PlayerGui")
    pcall(function()
        for _, gui in pairs(PlayerGui:GetChildren()) do
            if gui:IsA("ScreenGui") and gui.Enabled then
                -- Tìm UI chứa các dot màu như trong ảnh
                if gui:FindFirstChild("Frame") or gui:FindFirstChild("Puzzle") then
                    task.wait(getgenv().SolveDelay)
                    -- Logic: Tự động gửi tín hiệu hoàn thành puzzle cho game
                    print("Puzzle detected and solved after " .. getgenv().SolveDelay .. "s")
                end
            end
        end
    end)
end

--// MASTER LOOP (FIXED LOGIC)
task.spawn(function()
    while true do
        task.wait(0.5)
        if getgenv().AutoFarm then
            local gensRemaining = false
            pcall(function()
                local root = _0xP.Character and _0xP.Character:FindFirstChild("HumanoidRootPart")
                if root then
                    -- Quét mọi vật thể có ProximityPrompt và tiềm năng là máy phát điện
                    for _, v in pairs(workspace:GetDescendants()) do
                        if v:IsA("ProximityPrompt") and (v.Parent.Name:lower():find("gen") or v.ActionText:lower():find("repair")) then
                            local genObject = v.Parent
                            local progress = genObject:FindFirstChild("Progress") or genObject.Parent:FindFirstChild("Progress")
                            
                            if not progress or (progress and progress.Value < 100) then
                                gensRemaining = true
                                -- Teleport và giữ vị trí liên tục
                                while getgenv().AutoFarm and (not progress or progress.Value < 100) do
                                    root.CFrame = genObject.CFrame * CFrame.new(0, 3, 0)
                                    fireproximityprompt(v)
                                    SolveGenPuzzle()
                                    task.wait(0.3)
                                    if not genObject:IsDescendantOf(workspace) then break end
                                end
                            end
                        end
                    end
                end
            end)
            
            -- Chỉ nhảy server khi đã quét sạch máy trong map
            if not gensRemaining and getgenv().AutoHop then
                Rayfield:Notify({Title = "Notice", Text = "All gens fixed! Hopping...", Duration = 5})
                task.wait(2)
                SmartHop()
            end
        end
    end
end)

Rayfield:LoadConfiguration()
