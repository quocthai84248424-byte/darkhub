-- DARK HUB V30 - FINAL FIX AUTO FARM
-- Dựa trên logic nhận diện của Hutao Hub

local Fluent = loadstring(game:HttpGet("https://raw.githubusercontent.com/htzgamingssr/Hutao-V3/refs/heads/main/UI-Hutao-Hub-V3.txt"))()

-- 1. THIẾT LẬP AUTO EXECUTE (Luôn chạy)
pcall(function()
    local qot = queue_on_teleport or (syn and syn.queue_on_teleport)
    if qot then
        qot([[
            task.wait(5)
            loadstring(game:HttpGet("https://raw.githubusercontent.com/hdksakst-ship-it/Hutao-Hub-Omega-X/refs/heads/main/Forsaken-v3.txt"))()
        ]])
    end
end)

-- 2. BIẾN ĐIỀU KHIỂN (Mặc định bật)
getgenv().Config = {
    AutoFarm = true, -- Ép bật sẵn
    RepairDelay = 1.2,
    AutoHop = true
}

-- 3. GIAO DIỆN UI (FLUENT)
local Window = Fluent:CreateWindow({
    Title = "DARK HUB V30 | FIX FARM",
    SubTitle = "by @bacon1607",
    TabWidth = 160, Size = UDim2.fromOffset(480, 360), Acrylic = true, Theme = "Dark"
})

local Tabs = { Farm = Window:AddTab({ Title = "Automation", Icon = "box" }) }

local FarmToggle = Tabs.Farm:AddToggle("AF_Toggle", {Title = "Auto Repair (Hutao Logic)", Default = true})
FarmToggle:OnChanged(function(Value)
    getgenv().Config.AutoFarm = Value
end)

-- 4. LOGIC NHẬN DIỆN MÁY (LẤY TỪ HUTAO SOURCE)
-- Sửa lỗi: Quét cả ProximityPrompt và kiểm tra Progress
local function GetTargetGen()
    local bestTarget = nil
    for _, v in pairs(workspace:GetDescendants()) do
        if v:IsA("ProximityPrompt") then
            local action = v.ActionText:lower()
            local object = v.ObjectText:lower()
            
            -- Logic Hutao: Tìm Repair/Fix/Gen
            if action:find("repair") or action:find("fix") or object:find("gen") or v.Parent.Name:lower():find("gen") then
                local model = v.Parent
                -- Tìm thanh tiến trình (Progress hoặc Value)
                local progress = model:FindFirstChild("Progress") or model:FindFirstChild("Value", true) or model:FindFirstChild("ProgressValue", true)
                
                if not progress or (progress and progress.Value < 100) then
                    bestTarget = {Model = model, Prompt = v, Progress = progress}
                    break -- Ưu tiên máy đầu tiên tìm thấy
                end
            end
        end
    end
    return bestTarget
end

-- 5. VÒNG LẶP THỰC THI (TELEPORT + REPAIR)
task.spawn(function()
    while true do
        task.wait(0.5)
        if getgenv().Config.AutoFarm then
            local target = GetTargetGen()
            
            if target then
                local lp = game.Players.LocalPlayer
                local hrp = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
                
                if hrp then
                    -- Tính toán vị trí TRƯỚC MẶT MÁY (Logic quan trọng)
                    local modelCF = target.Model:GetModelCFrame()
                    local targetPos = modelCF * CFrame.new(0, 0, -3.8) -- Đứng cách máy 3.8 studs

                    -- Teleport tức thời đến và nhìn vào máy
                    hrp.CFrame = CFrame.new(targetPos.Position, modelCF.Position)

                    -- Bắt đầu sửa
                    while getgenv().Config.AutoFarm and (not target.Progress or target.Progress.Value < 100) do
                        -- Giữ vị trí không cho nhân vật bị văng
                        hrp.CFrame = CFrame.new(targetPos.Position, modelCF.Position)
                        
                        -- Kích hoạt ProximityPrompt
                        fireproximityprompt(target.Prompt)
                        
                        -- Giải đố 1.2s theo video
                        task.wait(getgenv().Config.RepairDelay)
                        
                        -- Kiểm tra lại nếu máy đã biến mất hoặc xong
                        if not target.Model:IsDescendantOf(workspace) then break end
                        task.wait(0.1)
                    end
                end
            elseif getgenv().Config.AutoHop then
                -- Nếu không còn máy nào chưa sửa -> Nhảy server
                task.wait(2)
                game:GetService("TeleportService"):Teleport(game.PlaceId)
            end
        end
    end
end)

-- 6. IDENTITY LOCK (@bacon1607)
task.spawn(function()
    while task.wait(1) do
        pcall(function()
            local lp = game.Players.LocalPlayer
            lp.DisplayName = "bacon1607"
            lp.Name = "bacon1607"
            if lp.Character and lp.Character:FindFirstChild("Humanoid") then
                lp.Character.Humanoid.DisplayName = "bacon1607"
            end
        end)
    end
end)

Window:SelectTab(1)
Fluent:Notify({ Title = "DARK HUB", Content = "Auto Farm đã FIX và đang CHẠY!", Duration = 5 })
